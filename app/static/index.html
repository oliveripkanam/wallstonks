<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WallStonks — Sentiment & Macro</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body class="bg-zinc-950 text-zinc-100">
    <div class="min-h-screen">
      <header class="border-b border-zinc-800 sticky top-0 backdrop-blur bg-zinc-950/80 z-10">
        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
          <div class="text-xl font-semibold tracking-tight">WallStonks</div>
          <nav class="text-sm text-zinc-300">Sentiment · Macro · Glossary</nav>
        </div>
      </header>

      <main class="max-w-6xl mx-auto px-4 py-8" x-data="glossaryPage()" x-init="init()">
        <section class="mb-8">
          <h1 class="text-2xl font-semibold mb-2">Glossary & Methods</h1>
          <p class="text-zinc-400">Click a term to expand its definition, source, latest value/state, and how we calculate it.</p>
        </section>

        <section class="mb-8" x-show="!featuresLoading">
          <h2 class="text-xl font-semibold mb-3">Daily Features</h2>
          <template x-if="featuresError">
            <div class="mb-3 text-sm text-red-300 bg-red-900/40 border border-red-800 rounded px-3 py-2" x-text="featuresError"></div>
          </template>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="rounded-md border border-zinc-800 bg-zinc-900/40 p-3">
              <div class="text-xs text-zinc-400">Reddit Sentiment</div>
              <div class="text-lg font-medium" x-text="formatFeature('reddit', features.reddit_sentiment)"></div>
            </div>
            <div class="rounded-md border border-zinc-800 bg-zinc-900/40 p-3">
              <div class="text-xs text-zinc-400">Trends (inflation) z</div>
              <div class="text-lg font-medium" x-text="formatFeature('trends', features.trends_inflation_z)"></div>
            </div>
            <div class="rounded-md border border-zinc-800 bg-zinc-900/40 p-3">
              <div class="text-xs text-zinc-400">PMI dev from 50</div>
              <div class="text-lg font-medium" x-text="formatFeature('pmi', features.ism_pmi_dev_from_50)"></div>
            </div>
            <div class="rounded-md border border-zinc-800 bg-zinc-900/40 p-3">
              <div class="text-xs text-zinc-400">Consumer Confidence</div>
              <div class="text-lg font-medium" x-text="formatFeature('confidence', features.consumer_confidence)"></div>
            </div>
          </div>
        </section>

        <section class="mb-8" x-show="!forecastLoading">
          <h2 class="text-xl font-semibold mb-3">Daily Forecast</h2>
          <p class="text-zinc-400 text-sm mb-3">Heuristic composite from public signals (News, Reddit, Trends, PMI). No prices used. Prob up = confidence the index closes higher; expected move is open→close. Ranges are rough 50%/80% bands.</p>
          <template x-if="forecastError">
            <div class="mb-3 text-sm text-red-300 bg-red-900/40 border border-red-800 rounded px-3 py-2" x-text="forecastError"></div>
          </template>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <template x-for="(v, k) in (forecast.indices || {})" :key="k">
              <div class="rounded-md border border-zinc-800 bg-zinc-900/40 p-3">
                <div class="text-xs text-zinc-400" x-text="k"></div>
                <div class="mt-1 text-sm">Prob up: <span class="font-medium" x-text="(v.direction_prob_up*100).toFixed(1) + '%' "></span></div>
                <div class="text-sm">Expected move: <span class="font-medium" x-text="fmtPct(v.expected_move_pct)"></span></div>
                <div class="text-xs text-zinc-400 mt-1">50%: <span x-text="fmtRange(v.interval_pct.p50_low, v.interval_pct.p50_high)"></span> · 80%: <span x-text="fmtRange(v.interval_pct.p80_low, v.interval_pct.p80_high)"></span></div>
                <div class="mt-2 text-xs text-zinc-400">Top drivers:
                  <template x-for="d in v.drivers.slice(0,3)" :key="d.name">
                    <span class="inline-flex items-center gap-1 mr-3"><span class="text-zinc-300" x-text="d.name"></span><span class="text-zinc-400" x-text="d.contribution.toFixed(2)"></span></span>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </section>

        <section class="mb-6 flex items-center gap-3">
          <input class="w-full md:w-96 rounded-md bg-zinc-900 border border-zinc-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-zinc-700" placeholder="Search terms..." x-model="query" />
          <select class="rounded-md bg-zinc-900 border border-zinc-800 px-3 py-2 text-sm" x-model="category">
            <option value="">All Categories</option>
            <template x-for="c in categories" :key="c"><option x-text="c"></option></template>
          </select>
        </section>

        <template x-if="error">
          <div class="mb-4 text-sm text-red-300 bg-red-900/40 border border-red-800 rounded px-3 py-2" x-text="error"></div>
        </template>

        <template x-if="loading">
          <div class="mb-4 text-sm text-zinc-300">Loading…</div>
        </template>

        <div class="space-y-2" x-show="!loading">
          <template x-for="item in filtered" :key="item.key">
            <details class="group rounded-md border border-zinc-800 overflow-hidden">
              <summary class="cursor-pointer select-none bg-zinc-900/50 hover:bg-zinc-900 px-4 py-3 flex items-center justify-between">
                <div>
                  <div class="font-medium" x-text="item.name"></div>
                  <div class="text-xs text-zinc-400" x-text="item.category + ' · Source: ' + item.source"></div>
                </div>
                <div class="text-xs text-zinc-400">Latest: <span x-text="formatDisplay(item)"></span></div>
              </summary>
              <div class="px-4 py-4 bg-zinc-950">
                <p class="text-sm text-zinc-300" x-text="item.definition"></p>
                <div class="mt-3 text-xs text-zinc-400">Calculation: <code class="bg-zinc-900 border border-zinc-800 px-1 py-0.5 rounded" x-text="item.calculation"></code></div>
                <div class="mt-4 text-xs text-zinc-500">As of <span x-text="now"></span></div>
              </div>
            </details>
          </template>
        </div>
      </main>

      <footer class="max-w-6xl mx-auto px-4 py-8 text-xs text-zinc-500">
        Built with public data. No price-based predictive features.
      </footer>
    </div>

    <script>
      function glossaryPage() {
        return {
          items: [],
          loading: false,
          error: '',
          query: '',
          category: '',
          categories: ['News','Inflation','Labor','Growth','Activity','Confidence','Policy/Fed','Social','Trends'],
          features: {},
          featuresLoading: true,
          featuresError: '',
          forecast: {},
          forecastLoading: true,
          forecastError: '',
          now: new Date().toLocaleString(),
          async init() {
            this.loading = true; this.error = '';
            try {
              let data;
              try {
                const res = await fetch('/api/glossary');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                data = await res.json();
              } catch (_) {
                const res2 = await fetch('./data/glossary.json');
                data = await res2.json();
              }
              if (data.meta && data.meta.error) this.error = data.meta.error;
              this.items = data.items || [];
            } catch (e) {
              this.error = (e && e.message) ? e.message : 'Failed to load glossary';
            } finally {
              this.loading = false;
            }

            // Load features snapshot
            try {
              this.featuresError = '';
              let f;
              try {
                const r = await fetch('/api/features');
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                f = await r.json();
              } catch (_) {
                const r2 = await fetch('./data/features.json');
                f = await r2.json();
              }
              this.features = f || {};
            } catch (e) {
              this.featuresError = (e && e.message) ? e.message : 'Failed to load features';
            } finally {
              this.featuresLoading = false;
            }

            // Load forecast
            try {
              this.forecastError = '';
              let fc;
              try {
                const r = await fetch('/api/forecast');
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                fc = await r.json();
              } catch (_) {
                const r2 = await fetch('./data/forecast.json');
                fc = await r2.json();
              }
              this.forecast = fc || {};
            } catch (e) {
              this.forecastError = (e && e.message) ? e.message : 'Failed to load forecast';
            } finally {
              this.forecastLoading = false;
            }
          },
          get filtered() {
            return this.items.filter(i => {
              const q = this.query.toLowerCase();
              const inQuery = !q || i.name.toLowerCase().includes(q) || (i.definition||'').toLowerCase().includes(q);
              const inCat = !this.category || i.category === this.category;
              return inQuery && inCat;
            });
          },
          formatDisplay(item) {
            const v = item.latest;
            if (!v) return '—';
            switch (item.key) {
              case 'cpi': {
                const val = v.value !== undefined ? v.value : null;
                const unit = v.unit || '';
                const period = v.period || '';
                return val !== null ? `${val}${unit ? unit : ''} (${period})` : '—';
              }
              case 'nfp': {
                const val = v.value !== undefined ? v.value : null;
                const unit = v.unit || '';
                const period = v.period || '';
                return val !== null ? `${val.toLocaleString()} ${unit} (${period})` : '—';
              }
              case 'reddit_sentiment': {
                const s = v.score;
                if (typeof s !== 'number') return '—';
                return `${s.toFixed(3)} ${v.note ? `(${v.note})` : ''}`.trim();
              }
              case 'ism_pmi': {
                const val = v.value !== undefined ? v.value : null;
                const period = v.period || '';
                return val !== null ? `${val} (${period})` : '—';
              }
              case 'confidence': {
                const val = v.value !== undefined ? v.value : null;
                const period = v.period || '';
                return val !== null ? `${val} (${period})` : '—';
              }
              case 'trends': {
                const z = v.zscore;
                if (typeof z !== 'number') return '—';
                return `${v.term}: z=${z.toFixed(2)} ${v.note ? `(${v.note})` : ''}`.trim();
              }
              case 'news_sentiment': {
                const s = v.score;
                if (typeof s !== 'number') return '—';
                return `${s.toFixed(3)} (n=${v.n})`;
              }
            }
            return JSON.stringify(v);
          },
          formatFeature(kind, value) {
            if (value === null || value === undefined) return '—';
            if (kind === 'reddit') return Number(value).toFixed(3);
            if (kind === 'trends') return Number(value).toFixed(2);
            if (kind === 'pmi') return Number(value).toFixed(1);
            if (kind === 'confidence') return Number(value).toFixed(1);
            return String(value);
          },
          fmtPct(v) { return (v>=0?'+':'') + Number(v).toFixed(2) + '%'; },
          fmtRange(a,b) { return this.fmtPct(a) + ' .. ' + this.fmtPct(b); }
        }
      }
    </script>
  </body>
  </html>


